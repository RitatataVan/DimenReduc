import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
from sklearn.manifold import TSNE
from sklearn.metrics.pairwise import euclidean_distances
import os
import copy
import umap
import seaborn as sns
import optuna
import torch
import torch.nn as nn
import torch.optim as optim
import torch.nn.functional as F
from torch.distributions import Normal
from sklearn.metrics import mean_squared_error
from torch.utils.data import DataLoader, TensorDataset
from sklearn.model_selection import train_test_split, GridSearchCV
from tqdm import tqdm


class NNModel(nn.Module):
    def __init__(self, input_size, hidden_size1, hidden_size2, output_size):
        super(NNModel, self).__init__()

        self.fc1 = nn.Linear(input_size, hidden_size1)
        self.bn1 = nn.BatchNorm1d(hidden_size1)
        self.relu1 = nn.LeakyReLU()

        self.fc2 = nn.Linear(hidden_size1, hidden_size2)
        self.bn2 = nn.BatchNorm1d(hidden_size2)
        self.relu2 = nn.LeakyReLU()

        self.fc3 = nn.Linear(hidden_size2, output_size)

    def forward(self, x):
        x = self.fc1(x)
        x = self.bn1(x)
        x = self.relu1(x)

        x = self.fc2(x)
        x = self.bn2(x)
        x = self.relu2(x)

        x = self.fc3(x)

        return x


df = pd.read_csv("/home/fanqiany/data/fanqiany/APOGEEDR17_GAIAEDR3_noflagfilter.csv")
chemical_abundances = ['FE_H', 'C_FE', 'CI_FE', 'N_FE', 'O_FE', 'MG_FE', 'AL_FE',
                       'SI_FE', 'P_FE', 'S_FE', 'K_FE', 'CA_FE', 'TI_FE', 'TIII_FE',
                       'V_FE', 'CR_FE', 'MN_FE', 'CO_FE', 'NI_FE']

# remove 'ASPCAPFLAG' and 'STARFLAG'
selected_df = df[(df['ASPCAPFLAG'] == 0) & (df['STARFLAG'] == 0)][chemical_abundances]

# remove outliers if exist
z_scores = abs((selected_df - selected_df.mean()) / selected_df.std())
data_no_outliers = selected_df[(z_scores < 3).all(axis=1)]

# standard scale
scaler = StandardScaler()
scaled_data = scaler.fit_transform(data_no_outliers)

# save cleaned dataset
cleaned_df = pd.DataFrame(scaled_data, columns=chemical_abundances)
# 10% of total dataset
# rows_to_select = int(0.1 * len(cleaned_df))
# cleaned_df = cleaned_df.sample(n=rows_to_select, random_state=42)
cleaned_df = cleaned_df.to_numpy()


# umap_train_loss_history = [0.4033192882474449, 0.25626051925310267, 0.2421196311037823, 0.23552066188110016, 0.23057145076840102, 0.2278532562961731, 0.2250778214789388, 0.22432264411958713, 0.22131331280553854, 0.22033539112687636, 0.2184858083773945, 0.21809486627124655, 0.21667510972892706, 0.21611069759164936, 0.21503816235500842, 0.2144233333881071, 0.2142408792533532, 0.21312852087543688, 0.21354128196318, 0.2121625827798317, 0.21107155217717677, 0.21117935336965435, 0.2106539736037846, 0.21014592189510672, 0.20953874333505448, 0.2092744968878839, 0.2089193939652932, 0.20832710698179066, 0.20753879054731977, 0.20708758915919276, 0.20596414516207012, 0.20630942776312847, 0.20575912858473105, 0.20503018914526933, 0.2052711817833866, 0.20454599687228486, 0.20415034108779298, 0.203886958039878, 0.20395160008401883, 0.20371330331292303, 0.20281577330986642, 0.20279652768836026, 0.20223092925104266, 0.2020140021974863, 0.20152404791402073, 0.2019774246045763, 0.2022037931146646, 0.20144059241321072, 0.2012379770641215, 0.20058940571260306, 0.20090725697202494, 0.20036255690188554, 0.2002212104020798, 0.20036397149942303, 0.19932389058118724, 0.20030269089303546, 0.19919162527348858, 0.19910234865615006, 0.1990333417314635, 0.19928006048327698, 0.19924453972759593, 0.19796538401156635, 0.198574026847484, 0.19805932675908916, 0.19845769579696, 0.19780900279324748, 0.1983639017661199, 0.1975183306820176, 0.19785392590118084, 0.19748665708807836, 0.19725102132781855, 0.1971943498557032, 0.1970813865722254, 0.19725838569670068, 0.19676185557943576, 0.19735677513925584, 0.19637326797917992, 0.196422891081853, 0.19667250931093802, 0.19629726006849554, 0.19671678680872862, 0.1965788191586312, 0.19626836994780714, 0.1958178766558708, 0.1962738485190375, 0.19647729185695242, 0.19517964752378042, 0.19527161253585748, 0.1955742269355977, 0.19543088159454136, 0.19564930728711596, 0.19500385903601633, 0.1943972964028691, 0.19512607485436548, 0.1947331700541635, 0.194803810252514, 0.19491770409898446, 0.19460598721324537, 0.19462792863277067, 0.19386458234978768, 0.19438859850192713, 0.1938047114039333, 0.19396398638902568, 0.1937631849727902, 0.19376198569475042, 0.19404061188267063, 0.1935405696878085, 0.19492194824996384, 0.19369985745279736, 0.19370618521325822, 0.19321403952200122, 0.19394065580488062, 0.1934080542622995, 0.19394247075051027, 0.1937513846943827, 0.1929011409638291, 0.19277584362785938, 0.1932033500962799, 0.19336281458064897, 0.1924547469569638, 0.19307343004148547, 0.19260393973225412, 0.19327782249733816, 0.19280478595770253, 0.19249068654667975, 0.19232740663718195, 0.192421790943873, 0.19233095311799783, 0.19254515816267187, 0.1926802263944836, 0.1921992350832397, 0.19242590533488627, 0.1922707411582515, 0.19257585692084284, 0.1921478521889324, 0.19168199046102932, 0.19190967630098876, 0.1917032709229615, 0.19162042618056055, 0.19172175833033753, 0.19198897005405158, 0.19159221898023432, 0.1910535762004014, 0.19196263443356143, 0.19175521241994423, 0.19213256572994164, 0.19151708950240667, 0.191502005024321, 0.19068453684577183, 0.1918964055109099, 0.19069283217941818, 0.19091643819184645, 0.19046878986980464, 0.19091139520218056, 0.19110846633880504, 0.19057649159321943, 0.19176921137809683, 0.19015579465274468, 0.1908867810347481, 0.19134400450085515, 0.19047035633698545, 0.1907921585765837, 0.19064311231657963, 0.19155929605152763, 0.190494758540436, 0.19038313929740286, 0.19051428729290834, 0.19015129650980891, 0.18994469303392617, 0.19029047322959716, 0.18922867248720562, 0.1899644074771926, 0.19000246452647726, 0.18971853701869246, 0.18969056716740945, 0.18982715432491995, 0.19017079969581063, 0.18882400614004066, 0.1899695623529991, 0.18912770747760027, 0.189472542928077, 0.1890254690469678, 0.19035870369015429, 0.1892401701893494, 0.1891519667249485, 0.18954250766944472, 0.1893671471217952, 0.18918763151962306, 0.1891757249086483, 0.1890065919312114, 0.1888480303176479, 0.1890319666766597, 0.18879779910981606, 0.1889430617235962, 0.18864595826273672, 0.1889178281557712, 0.18818395399461452, 0.18850931066921484, 0.18923456301004646, 0.18800166992496914, 0.18854460938991482, 0.18890961369951556, 0.18803147804800305, 0.18830862107902122, 0.18862927567434415, 0.1884904173868838, 0.18849791212673636, 0.18769320861073815, 0.18838789212253187, 0.18842832842282908, 0.18870308603046632, 0.18864436665645448, 0.18833643152939214, 0.1887000215686599, 0.1888632942863358, 0.18784238504360928, 0.1883742303308357, 0.18817047389825578, 0.1874245158113209, 0.1882534061879002, 0.18867147853851887, 0.1884899252145176, 0.1880447696155693, 0.18710261462796784, 0.1878708416183015, 0.18769567306736726, 0.18875523679588896, 0.18831687269858813, 0.18805969361652938, 0.18713797372012866, 0.18762079875787419, 0.18753461717036762, 0.18797241146435917, 0.18736398055792228, 0.18720469234107953, 0.1876344570460335, 0.18755193777419657, 0.18768884269960948, 0.18730631573404652, 0.1875333701193542, 0.18710269040809074, 0.1872762761727967, 0.18756951015077844, 0.18726557065618074, 0.18717270473652525, 0.18761134969439355, 0.18766131680810752, 0.18733438252579135, 0.18784814795000754, 0.18742859815187188, 0.18698192348588136, 0.18758278687171756, 0.18766061446248075, 0.18753359246707157, 0.1872910120267029, 0.1863495856334314, 0.18687569288625525, 0.18730092871441978, 0.18714538411021597, 0.18669541935709166, 0.1875454707759678, 0.18681608550587195, 0.18689251581756572, 0.1866756431311558, 0.1871889872049785, 0.18714217777742426, 0.18680276004592675, 0.1863969664936399, 0.1869208032085983, 0.18653995675434853, 0.18724176008080393, 0.18640595034685242, 0.1864602990229782, 0.18666510085620983, 0.18676639948978177, 0.18733139155701495, 0.18699347607936662, 0.18662243708439516, 0.18683631160130323, 0.1868733355802047, 0.18688262555550955, 0.18673039967885197, 0.1872007663842588, 0.18747324219997563, 0.18683895606048717, 0.18668350538401512, 0.18650905645933577, 0.1869533116415124, 0.18673176323916116, 0.18667807538707562, 0.18701441270832841, 0.18643611740434718, 0.18686292342025285, 0.18703828437969036, 0.18611495959851354, 0.1869140156100334, 0.18621671890712085, 0.1865858940827908, 0.18740261318000012, 0.1866158926277291, 0.18587611562459247, 0.18618594894635151, 0.1866120498409566, 0.18659627136763718, 0.1862405078513849, 0.18586386617339035, 0.1860112939718564, 0.1866216476745411, 0.18691563767861177, 0.18609277012345682, 0.18675999942157256, 0.18629530599968633, 0.18651312627707953, 0.18625167552547303, 0.1862137246763157, 0.1861441036354784, 0.18627723565343088, 0.18667287290078477, 0.1858060192501797, 0.18611983534548812, 0.18609966778516573, 0.18651648618231362, 0.18589886330389194, 0.186369453745966, 0.1866664262860624, 0.18608978340833926, 0.18593633952952987, 0.1862779281973901, 0.18588579515914366, 0.1863543211754927, 0.18621911098922517, 0.18631978371058935, 0.1855814209443975, 0.186009169241447, 0.1865053916161781, 0.18576936748645884, 0.18603109389007097, 0.18617509148663816, 0.18611350486833936, 0.18637103020735304, 0.18573919343747144, 0.18615056008859535, 0.18577497569634477, 0.18535495894396312, 0.18577127054025402, 0.18580486733332555, 0.1858721776869666, 0.18600434595626467, 0.18584580931486155, 0.18587843013473956, 0.1854900435883093, 0.18615366395851418, 0.18576362806755822, 0.18614684406241414, 0.1851565905371082, 0.18514332264178773, 0.18590697102024412, 0.1857460861365784, 0.18512478121116382, 0.18554266258340782, 0.18541429900381384, 0.18592951555895443, 0.18551403121806143, 0.1859868684255905, 0.1853801261849823, 0.18557104803006869, 0.18572700362541525, 0.18522157297523306, 0.1855665689885318, 0.18529888542698855, 0.18569591618610806, 0.18526777343398668, 0.18560886120847844, 0.18553976234711084, 0.18600392801703397, 0.18593277184163157, 0.1858226588779536, 0.18587725580103662, 0.18529419700126595, 0.18606776843345924, 0.18548997192272765, 0.18614988154765427, 0.18535282054219185, 0.18511006138694056, 0.18559627360030279, 0.18574635018617866, 0.1847635761044702, 0.18559124499094193, 0.18512415979857477, 0.1855382020011031, 0.18482007567178624, 0.18491923514456146, 0.1855261073009474, 0.18543588176043577, 0.18511154406750405, 0.18548774671827012, 0.18507489233717142, 0.18550179654114526, 0.1856392488441151, 0.18552818474362523, 0.18515110486197822, 0.18589890182721658, 0.1856922438016651, 0.18547091662296125, 0.1849318794603976, 0.1857306422810815, 0.18532865842673124, 0.18506633228059577, 0.18572813219722814, 0.18565437393117604, 0.18456941453948816, 0.18547952995377576, 0.1851539020255109, 0.18489977839377883, 0.185393755479927, 0.18518078584490813, 0.1851830678571908, 0.18532345265726574, 0.18553674342571927, 0.18539294701096581, 0.18506619555362175, 0.18483590096651514, 0.18490041854606107, 0.1854353268872241, 0.18454002552872428, 0.18555044208579746, 0.1853224691550293, 0.1849239973148387, 0.1846984591697042, 0.1850083037421794, 0.18525615501340595, 0.1852510648294955, 0.18507356078058104, 0.18534151509385263, 0.1858411993035922, 0.18465089610888324, 0.18475263521873228, 0.1849693523906185, 0.18499599496122882, 0.18510625985131002, 0.18495841092949034, 0.1848824266765835, 0.18477883311282778, 0.18456402506360162, 0.18528430252005212, 0.18516205144931064, 0.18471453601014615, 0.18486740953140185, 0.18495203000831056, 0.18486075938544821, 0.18512267645135988, 0.1846204001830169, 0.1848867131449019, 0.1846108950495907, 0.1846816331911625, 0.18479569482010041, 0.1849945411525694, 0.18494478328392355, 0.184547173055606, 0.1853344635514168, 0.18492801689221955, 0.18481812056576094, 0.1849216298365114, 0.18475666529670734, 0.18461316919227064, 0.18460053673370325, 0.18489313894986162, 0.18446730986984308, 0.18547798346387806, 0.18474349356167738, 0.18511810733175266, 0.18406601662961317, 0.18441864194284321, 0.18456923959969992, 0.1841093669755739, 0.18411885554399277, 0.18484118858385554, 0.18459221740617132, 0.18465526875664115, 0.1848492703330785, 0.18439927570195183, 0.1837814887972371, 0.1842761783879335, 0.1851386451651744, 0.18456373219217959, 0.1845094157056337, 0.18428986347458862, 0.18435711731088197, 0.18461973569628923, 0.1844563750318242, 0.1848533400295117, 0.18395093608244423, 0.1843825881131173, 0.1844397129916532, 0.18467650764022683, 0.18436865619405246, 0.1842199027509363, 0.18439248085369211, 0.18448041314901198, 0.18505850442205163, 0.18431421068319417, 0.18391090180744057, 0.1848119640946433, 0.183584601941311, 0.18393453202078275, 0.18486062718591642, 0.18492571218819176, 0.18475131517328616, 0.18491223223206354, 0.18423022828404653, 0.18431561700156684, 0.18430410245951942, 0.1840213031173242, 0.1846643381304324, 0.18468555407631307, 0.18518871598157705, 0.18403086026625348, 0.18456270737091185, 0.18468445566741531, 0.18445987822926865, 0.18421456142753614, 0.18394685907733033, 0.1845965966659091, 0.18460180509418964, 0.1844202419440361, 0.18399914580402385, 0.18387100751921384, 0.18419600468507596, 0.1845213410418334, 0.18423719397202146, 0.18395519827530304, 0.18383309604478065, 0.18368201514467986, 0.18421301811063198, 0.18429933104070612, 0.1839265460178364, 0.18401839043612583, 0.1843721705609684, 0.18469336660410096, 0.18463968429223357, 0.1840969967424972, 0.18367965245756168, 0.1841077590101783, 0.18451083683947112, 0.18442346357419587, 0.18379163760651537, 0.18397469640298994, 0.18448807752882984, 0.18359739224378663, 0.18401481760199034, 0.18396382729412772, 0.1842294334697531, 0.1842917052910552, 0.184472915832702, 0.18412297213195072, 0.18417622085664312, 0.18410185810582794, 0.18471559089082557, 0.1838180603457669, 0.1842375561618335, 0.18412414592365162, 0.18354360195331287, 0.1841172873383988, 0.18391413444680837, 0.18388966310415125, 0.1840957119639116, 0.18431360680387074, 0.1837883990084638, 0.18458755486522033, 0.18318693033098257, 0.18419633402310848, 0.18393418604762768, 0.18392522099532008, 0.18382626714721734, 0.18392176256034504, 0.1832394430936785, 0.1842851992397421, 0.1839841951125232, 0.18399423388648098, 0.18398113346200462, 0.18420175307539047, 0.18366099904174543, 0.18425774852737514, 0.18393905060398488, 0.18357935763071379, 0.18489382335043478, 0.18425276992243375, 0.18380357883550633, 0.18440955524056743, 0.1840269996668673, 0.1840324884348591, 0.18394457506731934, 0.18454470481497898, 0.18390343585045685, 0.18442016499309974, 0.18409550021027546, 0.18429080265730596, 0.18404390969022855, 0.18403755678955333, 0.18423414599842947, 0.18372388235265852, 0.1838059741440253, 0.18391694707576312, 0.18378952628592682, 0.18397949995907492, 0.18403093981479315, 0.18380477723321012, 0.18370337394538527, 0.18424084101480778, 0.184218861012972, 0.18378526726383565, 0.18413732264020355, 0.18344058373976221, 0.18329177671634855, 0.18411840387042067, 0.1842325170541043, 0.18391850797601522, 0.1830582904204892, 0.18361409941481033, 0.18396385256678202, 0.18407488500411287, 0.1840770186057715, 0.18392832076850468, 0.18353187601377025, 0.1839948076496328, 0.1835322535165315, 0.18369664140176414, 0.18353669260238922, 0.18380456453246152, 0.18358504129796988, 0.1840588671561984, 0.1845499742891623, 0.1833686772109289, 0.1838983365348691, 0.1835040756232691, 0.1839230114777598, 0.18374982359486972, 0.18404717671389503, 0.183867634876375, 0.18390651396136634, 0.18371869969451673, 0.18381216489927701, 0.18383048155374723, 0.18334702721043816, 0.18360864119814993, 0.18373346626335657, 0.18341762498460737, 0.18344627537344682, 0.1843181915970199, 0.1836499994806681, 0.18390655835322656, 0.18299320795571833, 0.18423438999729255, 0.18427221896499005, 0.18379762097864852, 0.18356320771793333, 0.18430171867549994, 0.18327840485123365, 0.1837488011374877, 0.18369056104687742, 0.18346936607883477, 0.1840763400392328, 0.1837490609323162, 0.18364135769307635, 0.18349756081533963, 0.18354256648231687, 0.18375651784665786, 0.18343993095003985, 0.18419474284530835, 0.18362435912416392, 0.1836534861587358, 0.1835932921663019, 0.18356162842411253, 0.18386272847122676, 0.18359593969275004, 0.18356012218037146, 0.18328751611054295, 0.1843253018081175, 0.18372439685617714, 0.18395799564472973, 0.18384559757813318, 0.18308609075200452, 0.18313111801002868, 0.1839877246154308, 0.18379805280737743, 0.18325295449705528, 0.18334196919162293, 0.18333638851588654, 0.18338394041057485, 0.18362817115704985, 0.18303053629270136, 0.18340555374078696, 0.18378939411755735, 0.18426065980404252, 0.1834592261074175, 0.18414819780791417, 0.18381178675212323, 0.18398012641662354, 0.18379723471704507, 0.18366917792174306, 0.18414650004824812, 0.18335319318050355, 0.1836220813354907, 0.1836690009207889, 0.18364643219008955, 0.18324426233332192, 0.18371275144456187, 0.18381196886370044, 0.18310333855171362, 0.1834130813836143, 0.18383604026560163, 0.1839794218551321, 0.1832586619267053, 0.18347773639685153, 0.18364367804950021, 0.18349931730376623, 0.18314889032638262, 0.18380136029867572, 0.1834011282739829, 0.1835103788333741, 0.18356007790203116, 0.18260948056801268, 0.18374695070463526, 0.18329053156289876, 0.183474952580815, 0.1833889909259448, 0.1836705881309559, 0.18401437747962837, 0.1832646894146894, 0.18335705129914523, 0.18328312940968455, 0.18381352211916382, 0.1828301353803697, 0.18339555871874857, 0.18334353790026603, 0.18304757125922194, 0.18386544816519274, 0.18366936622906038, 0.18346901390103604, 0.1830031286656024, 0.18353402954040376, 0.18318706607745594, 0.1833177314407217, 0.18332096920851962, 0.1833973490850859, 0.1832099078592188, 0.1836732766503438, 0.18410551032601377, 0.1835590268443026, 0.18282614525028318, 0.18323988373912256, 0.18321419263586755, 0.18353362406499446, 0.18368146950442313, 0.18332042689706812, 0.18323110347835306, 0.183624514162349, 0.1829907412732081, 0.18321527086715292, 0.18320136008505522, 0.18327239956752672, 0.1840921122177604, 0.18322050717014277, 0.18347194036711623, 0.18289559748140885, 0.1836949139221333, 0.1835406556390507, 0.18348518694517316, 0.18315117754611418, 0.182760445028933, 0.18345153544439533, 0.18324331157936152, 0.18314327402319294, 0.18332925840875053, 0.18311969921982255, 0.18321253627202572, 0.18314174795575455, 0.1830305125269686, 0.18296135357794, 0.1837045753012851, 0.1832155945859485, 0.18295701874122475, 0.18319119669514264, 0.18288527606283989, 0.18301279876241763, 0.18297251770842538, 0.18322853700514022, 0.18317701006627474, 0.18385958405688324, 0.18365786031118936, 0.18335361804111158, 0.1824688273099799, 0.1829686025003846, 0.18309735355913903, 0.18342442827006952, 0.18336453008054307, 0.18312170531299385, 0.18306481864157834, 0.18300741132877701, 0.18300791122495072, 0.1835993355237055, 0.18319538692637763, 0.1832907563568595, 0.1830904183323473, 0.18338295064470891, 0.18335501589111952, 0.1831779120611961, 0.1830431606345932, 0.18269365526659545, 0.18332931531562738, 0.18259702555112392, 0.1832854606117142, 0.18331148506292655, 0.18291863128325878, 0.18332414399723698, 0.18357742155374623, 0.1830177951131963, 0.1827220037680814, 0.18414815522124353, 0.1835264426490726, 0.18346554990469702, 0.18308582738797563, 0.18343991329991546, 0.18327470602666177, 0.18326978087402973, 0.18334168169347795, 0.1826841257174792, 0.18347987814189623, 0.18304098552136452, 0.18304300955291183, 0.18344057836314634, 0.18323278173707458, 0.1831944065470524, 0.18308029562263814, 0.18349612219943184, 0.18319457573293793, 0.18327662881400605, 0.18350906133878772, 0.1834488685383132, 0.18297320049968646, 0.18356198626010106, 0.18281961030480717, 0.18291111767127308, 0.18334543479838697, 0.1828133022088931, 0.18353032768863356, 0.18313785886731584, 0.18348968153448972, 0.18276996990703773, 0.18316971608086674, 0.1829251099873964, 0.1831815334495895, 0.1826029644089734, 0.18275855875939445, 0.18261980065550473, 0.18273824920788917, 0.18336813672803873, 0.18342698190996473, 0.18300782171893185, 0.18301668786977635, 0.18287139772852432, 0.18365395263441736, 0.18333319173435073, 0.1824575577228115, 0.18333887953172923, 0.18350830868602164, 0.18326504127863888, 0.18290130198625107, 0.18355674130065952, 0.18321758112364117, 0.1827225535774135, 0.18336980299371272, 0.18286704221671224, 0.18292105492613156, 0.18388635896502994, 0.18294180613474384, 0.18251391059677083, 0.18343568471786165, 0.18316048698674947, 0.18307187432749186, 0.18330350252901592, 0.18327129520662283, 0.1828090433637595, 0.18349272182656595, 0.18355475814741912, 0.1830677779471957, 0.18289751160117204, 0.18385068815045988, 0.1827469255055419, 0.1831850673107724, 0.18281364603518585, 0.18276363820120256, 0.18314637015038426, 0.18270876226725932, 0.18298743411134022, 0.18299779142446823, 0.183027381969848, 0.18297409502455078, 0.18360869386806206, 0.18240817054350478, 0.18238966004261203, 0.18288613549112356, 0.1835286568554515, 0.18314111896181437, 0.18349060425792907, 0.18312007361747962, 0.18270679544308283, 0.1832478723674957, 0.1831796976329855, 0.18309842331538198, 0.18280412212422648, 0.1836024502748442, 0.18332661498682717, 0.18326227492797864, 0.18313588728420552, 0.18350249882466105, 0.18267666501134902, 0.18305320176798498, 0.18337142579905777, 0.18281536534249412, 0.18260818401674184, 0.1825121881331631, 0.18306428261378924, 0.1833155577943487, 0.18297481950879124, 0.18332244343741247, 0.18288412901287485, 0.18284421618194538, 0.18315586106599477, 0.18263197513457882, 0.18305018116605318, 0.18299139247921603, 0.1834767813936841, 0.18288192452024118, 0.18280376038181656, 0.18286013778164706, 0.18373094087879638, 0.18336834231264534, 0.18296211752037514, 0.18330256917922008, 0.18311753024779992, 0.18319060829014477, 0.18254218480724832, 0.18269496766057522, 0.183342503759234, 0.18282127481648686, 0.18301048196740358, 0.18334286793008023, 0.1826889197289859, 0.18259355872012528, 0.1824886383631648, 0.1826284635155131, 0.18310639562915942, 0.18269889084283514, 0.18286962247480687, 0.1831765449550583, 0.18281868964587256, 0.18311241835041908, 0.18237486001321418, 0.1827572174545577, 0.18247584539742243, 0.18276584242116578, 0.18337433495223454, 0.18289330929341902, 0.1833638316313212, 0.1823916827731318, 0.18310783615264734, 0.18265916099714125, 0.18258183662356642, 0.1831386946578549, 0.183218512170763, 0.1831481895845032, 0.18284096033887978, 0.18251442831446177, 0.1827026889494958, 0.18254063470697143, 0.18337337789791766, 0.1832043873423716, 0.18310273819484707, 0.18324566254610264, 0.18277616077024467, 0.18280256462957248, 0.18319283746891304, 0.18274690709973088, 0.1826500188615219, 0.182500410092421, 0.18300322287379517, 0.18300709187476966, 0.18273418773942554, 0.18299721902244273, 0.1823757156997917, 0.18298760544074927, 0.18288483314254533, 0.1826494772912888, 0.18299473179616266, 0.18283449849467875, 0.18290997743473014, 0.18284001597765, 0.1825951917077635, 0.18300892231030605]
# umap_test_loss_history = [0.251211657799084, 0.23001224083128366, 0.2206960889809589, 0.2123020242394261, 0.2086959114038293, 0.20545708018023393, 0.2045923894953392, 0.201198054418241, 0.20007292233643154, 0.20027339710036396, 0.19683546338129793, 0.19719672151369808, 0.19570855601357223, 0.19471778003993803, 0.19328624739146197, 0.1955368906685777, 0.1940712523804719, 0.19087225250439885, 0.19425825047501438, 0.19125501775223858, 0.1935630732653206, 0.18917166036834165, 0.18994502796557056, 0.18923747295071996, 0.1873551787922401, 0.1908191717052937, 0.18757524351945196, 0.1861971333523328, 0.18778138860229363, 0.18597077747661603, 0.18666654778802683, 0.18512229250369844, 0.18980005787139984, 0.18614158948126017, 0.18463768337190833, 0.18349992899327314, 0.18396032580255087, 0.18461485545791653, 0.18392542097623624, 0.18457074251304556, 0.18343684095347487, 0.18437733112098595, 0.18105123098059772, 0.18123783358867326, 0.1828025620846793, 0.18472455326210255, 0.18140905101185148, 0.18228434596657686, 0.18043101093420869, 0.18289860045419315, 0.1804361459748509, 0.18174858068154717, 0.18275819652175088, 0.1834728516959072, 0.18110224750674622, 0.18354698995974703, 0.17972042853970957, 0.18006827775712392, 0.17848088733434295, 0.18021069176434143, 0.17776546517189562, 0.1791810996012761, 0.1792827360330621, 0.18092568478458665, 0.18070776523920182, 0.18343434223145721, 0.18024715283356485, 0.17866374445745473, 0.17934659786652876, 0.17981497141279382, 0.1784230260419598, 0.17754957974546898, 0.18227822273282993, 0.17757794740248653, 0.1782028844902169, 0.178479082089742, 0.18238238716144184, 0.17698530270025084, 0.17705283575493083, 0.1783434838015387, 0.18244071246593507, 0.17797886953133438, 0.18002300127857165, 0.177124331828491, 0.17888746508738163, 0.17579394144680524, 0.17571857867744292, 0.17636014841915115, 0.17823911060921094, 0.17785531065353977, 0.17543445083840725, 0.1782793976126412, 0.1759563317340378, 0.17542893503439552, 0.1783174366663683, 0.1765830953032643, 0.17904090012396115, 0.18075897170437955, 0.18048592946733183, 0.17440927259805128, 0.17736716696620322, 0.17503423257254963, 0.17619966778147012, 0.17610645640301043, 0.17448193474826698, 0.17813931240668293, 0.17550322273664404, 0.18054799608286112, 0.17436202650583638, 0.17718551335933874, 0.17614077377111892, 0.17731046647756013, 0.17457805418134417, 0.1765860393685113, 0.17538280402802964, 0.1739739865485297, 0.1746706925364542, 0.1745348850126659, 0.17467754158901935, 0.1785868186932254, 0.17654440055059004, 0.1758388537981587, 0.1752048688137156, 0.17677546076613182, 0.17696864363439738, 0.17351225390877287, 0.1744353561316965, 0.1748902893591917, 0.17464650326263664, 0.17340360989362819, 0.173296021169382, 0.17588763601485063, 0.17439936448438523, 0.1745432794123021, 0.17281474950206374, 0.17528113903090847, 0.1789333525057525, 0.17378749685796915, 0.1732293256657978, 0.17284193653961805, 0.1750440810565307, 0.1733040717872825, 0.17452488989144294, 0.17465952214602995, 0.17547577637692865, 0.17342449885877645, 0.17370981800833962, 0.17548305105938664, 0.17564074387171166, 0.1744734618703318, 0.17263018249866655, 0.1722807475225925, 0.17409206227309995, 0.1728677706175083, 0.1729599677076074, 0.17108864454199393, 0.17241288676989827, 0.1767885023866082, 0.1734989019875708, 0.17824188430687057, 0.17434020766460395, 0.1761946573415567, 0.1727636825365502, 0.1739268213879996, 0.17220312936657942, 0.1728526128412802, 0.1732959658788902, 0.17234507543649208, 0.1720693097630859, 0.17506246271809708, 0.17187604714726007, 0.17699867513830247, 0.17631464402500413, 0.17429862367866011, 0.17199888974656322, 0.17282760275158562, 0.17187810783556903, 0.17281204002312814, 0.17169149119439353, 0.1718460322016228, 0.17370326927212676, 0.17106291943806112, 0.17244074613144153, 0.17344158702231605, 0.1702277614596337, 0.17383751787370197, 0.17257193772076287, 0.17265935122706347, 0.17047654930881256, 0.17301771961314757, 0.170905355384812, 0.17304882789135353, 0.17049755205508552, 0.1722870767639609, 0.17232664958059335, 0.17322770369952553, 0.17068111227217433, 0.172796666488614, 0.17298507478589362, 0.17310586763278984, 0.17430227615865423, 0.1752935926951564, 0.17366804938799968, 0.17072744433320464, 0.17290238284431236, 0.17470448885359646, 0.1739099469094152, 0.1714581195171154, 0.17522281690318545, 0.1720763322915653, 0.17053183173431283, 0.17675377797123795, 0.17383295869485832, 0.17157795697694364, 0.1737756344157518, 0.17394483398610364, 0.1712553646145455, 0.17181264055959808, 0.17180838405812196, 0.17065809591488956, 0.170317770490133, 0.17084925577148544, 0.1738918639955699, 0.17159504296921727, 0.17041696268298492, 0.170960365900707, 0.17168256811041682, 0.17034136606071165, 0.16957021145424603, 0.1729195207572196, 0.17317616618584605, 0.17500422397822696, 0.17262768832117195, 0.16928859383236183, 0.17009269069112207, 0.17149165141056755, 0.17157064351051185, 0.17021165204402502, 0.17394184564639564, 0.16956093736748845, 0.16932360953736053, 0.1717064480389325, 0.17430392456796323, 0.1721631034870937, 0.17313170442893588, 0.17087512802570662, 0.17405310810478108, 0.17200812913925084, 0.17118720604719087, 0.1713376760704255, 0.17014038419099398, 0.17257435568582086, 0.1693707197824458, 0.1727574738405066, 0.17143153841634226, 0.1715710740571925, 0.17152316670320475, 0.1728623349655956, 0.17088704761918289, 0.16939884393493582, 0.17322666318625643, 0.1712839192502809, 0.1697120765524095, 0.1723558727180661, 0.1718575613956935, 0.1695419271695008, 0.1703887573740045, 0.17187023383140154, 0.16950961314424148, 0.1695699306909728, 0.1698623811114898, 0.17197425363934454, 0.1739142366526281, 0.17306185628168658, 0.169596246176141, 0.17129887506483188, 0.17130912863681597, 0.17308222651737595, 0.17235430186334988, 0.17009961806395452, 0.16991561513230383, 0.17170725137283557, 0.17115572366242074, 0.1731364205738371, 0.17061556060896715, 0.17348868838479795, 0.16991211115477034, 0.16905718068649808, 0.16945610432974445, 0.17257121371819586, 0.17053601957103343, 0.1715605970579353, 0.17387193177800864, 0.17415374152076055, 0.17028612789297892, 0.1736814289463791, 0.16965900515897026, 0.17110221888885999, 0.17337520916069582, 0.1705692860236058, 0.17185459183838198, 0.17209165381140587, 0.17018039166535598, 0.1693598525117664, 0.17043140524687878, 0.17457243657656552, 0.17133066734968402, 0.17021929545774503, 0.1705673792820594, 0.17102580240390766, 0.17018418244085753, 0.16960682568063015, 0.1718488686061332, 0.17041120310011604, 0.17077607770911465, 0.16888848319719252, 0.16974579219717242, 0.1743766246836155, 0.16952080391351582, 0.17058403491907104, 0.1700317146231317, 0.1694653131254998, 0.16915897751040124, 0.1687777523923621, 0.16796835509001476, 0.17098594371245687, 0.17055094432123452, 0.16908340416607995, 0.16862241008727846, 0.16979547540855006, 0.16981687526055797, 0.17245929748562205, 0.17109951669440482, 0.1692437878997497, 0.16906469300461072, 0.17145229831080291, 0.17280927454311473, 0.16951250062246934, 0.1688674872824501, 0.1717130921472512, 0.16987140469525444, 0.17022314617676912, 0.16948019010061607, 0.17093482779775004, 0.16908848834723772, 0.16983580067122223, 0.17221128209797146, 0.1721389728508117, 0.1711428896421243, 0.17046538987265322, 0.16918345035756202, 0.17109493625752087, 0.17142389146471634, 0.17042361697878108, 0.16856262851103743, 0.17085757698855258, 0.17130030511667918, 0.1685757400232405, 0.16933645874260744, 0.17435000259978015, 0.1696052882891176, 0.17538254761443012, 0.17067332612637504, 0.17164357201251515, 0.16936818622835872, 0.16881239049851954, 0.17235817117335178, 0.16867451860161367, 0.16907517982130646, 0.17491144137638207, 0.17196572985963482, 0.17222654288802636, 0.17423788032341567, 0.17190914979167185, 0.17003874596744056, 0.16796508369056642, 0.17089476670558346, 0.1712081320073278, 0.17167618600245066, 0.17002372969075613, 0.1679631847209502, 0.16931405741504515, 0.17032089341605608, 0.17245530186269623, 0.16919597995657826, 0.1711847130994497, 0.17364988096734177, 0.17002396314803148, 0.17130385466965262, 0.17089971107157018, 0.1708580818524028, 0.16844269374711068, 0.17010150276676198, 0.16792510358294735, 0.1707957351368881, 0.16924707516079107, 0.16948257855993928, 0.16874713534777586, 0.16931303976294734, 0.17047077189785811, 0.17106211496176724, 0.17026593540506663, 0.17203900939613662, 0.17052636097544466, 0.17204527010295864, 0.17112325918879687, 0.17062371138443916, 0.1733612393245806, 0.16897650212221985, 0.17326801789775584, 0.17008147201312301, 0.17034140274074988, 0.16995268956802215, 0.16942563640917294, 0.17352781048846336, 0.170939976311704, 0.16983631077571384, 0.168797386702441, 0.17033934310524337, 0.1706025955364664, 0.16915561351497363, 0.16883662234294974, 0.1700731977203294, 0.16934472525679348, 0.16979764038439876, 0.17056924204128077, 0.16982720147925026, 0.17051265435218543, 0.17124732061116021, 0.16966617053415756, 0.17009352970234135, 0.17062144572072258, 0.1718754390815031, 0.1712193282743232, 0.1690882206577455, 0.17118124367743023, 0.17098467945585133, 0.1694324414438003, 0.16817562138521447, 0.17268413861398224, 0.16931411884985234, 0.16922631321748335, 0.1714096318680959, 0.17142021861421888, 0.17015005660544963, 0.1731103564124248, 0.1735517212554104, 0.17080960789482333, 0.17137494772019382, 0.17041334913887532, 0.17017901966120771, 0.16952702890295726, 0.1742116686661599, 0.17137892379950023, 0.16823894425226676, 0.17003443219228662, 0.17148191675890453, 0.16918547030987235, 0.17292462361393554, 0.16922428908512435, 0.16809348586364262, 0.16797670119706812, 0.16992428406075308, 0.16990658437924377, 0.16790946464594841, 0.16968861979149763, 0.16929916482428653, 0.17277669765834486, 0.1718374915158643, 0.17050855336276433, 0.1697835503791186, 0.16826510014660512, 0.16758262658665413, 0.17007328091898946, 0.16752230798433812, 0.1684168107484061, 0.16835010924573982, 0.17042986077398986, 0.16828994130212627, 0.17162295940689876, 0.16865462163791053, 0.1683294569775159, 0.1687693988478047, 0.17453322326303655, 0.17171893642395997, 0.16797380774702422, 0.16953240565858538, 0.1698816233606049, 0.17051944510664924, 0.16882436363857486, 0.17031887884739466, 0.1684939283519397, 0.17071777694014928, 0.1692217531199416, 0.16804427813057352, 0.17048372172698123, 0.1714925386681844, 0.1689667582301564, 0.1698802659187401, 0.17109977391207387, 0.1704294116747264, 0.16811422723890745, 0.16953793630588757, 0.17007288631449502, 0.170480296136489, 0.17099799031608826, 0.17392942583319668, 0.17078034508250114, 0.1702263946877801, 0.17061474016813707, 0.1691137186212177, 0.17101673116135613, 0.1688524420926496, 0.16870507889280237, 0.17055179504293355, 0.1697444016343204, 0.16900127296311268, 0.1687452497179235, 0.16893479011505214, 0.16741276396164914, 0.16987971464588855, 0.16872758952207084, 0.17074258302098905, 0.16772396071235676, 0.1682664842084576, 0.17191290276644589, 0.16682398579050656, 0.1700777281218306, 0.17009799058827574, 0.16999761215136902, 0.16994766135066008, 0.16874208316413375, 0.1698559018574568, 0.17083950603447642, 0.1679725266255472, 0.17049999284125045, 0.16991274242113283, 0.17160946548924363, 0.1757360618310965, 0.1705134731370218, 0.1695555068477095, 0.17127917515046967, 0.17205923149829136, 0.17158084370062596, 0.16976360009531136, 0.167834235368265, 0.17018946553101047, 0.16760464358678778, 0.16961740794065727, 0.17005447727561313, 0.16812732346099113, 0.16992750275107885, 0.16774508654525938, 0.1671878973807323, 0.16816750722411963, 0.1752925764764725, 0.16946795603359932, 0.17079783921267758, 0.17014476454477429, 0.17200341709093087, 0.16889909678755236, 0.16871190712692233, 0.16849449657034787, 0.1688649868321003, 0.16928311933359655, 0.16821053747796216, 0.1692018313519455, 0.16948643342562505, 0.1678990635146856, 0.1694628259959946, 0.16908772970346345, 0.16729960821444043, 0.17102567768576807, 0.16723914275174626, 0.16807686898445165, 0.16872835540135797, 0.16810779120096853, 0.1710792553948343, 0.17040487028801118, 0.16857907124045377, 0.16996858833466408, 0.17231444878424873, 0.16921092538054766, 0.17007449471675423, 0.16980937290456075, 0.16989208407648035, 0.17095791525370047, 0.16945070917678293, 0.16812783975375767, 0.1694493668664494, 0.1711680456812892, 0.17167681711078148, 0.1683395169907668, 0.16783568906031293, 0.1684547612103645, 0.1695251180286604, 0.16763060827784365, 0.16906599205600356, 0.1691852156641129, 0.17010864592013844, 0.1696620674196558, 0.16829651263408404, 0.17244278895716506, 0.17164747757464563, 0.1707354387079718, 0.1693298844959672, 0.1709000672849442, 0.16809290810268193, 0.16815144742321783, 0.16995641318841567, 0.17420606429653263, 0.17097499479839376, 0.16983101256181993, 0.168613306050932, 0.16743026908615483, 0.17205421756554445, 0.16884230374076858, 0.17087406304702227, 0.1704139190444384, 0.16963821350904945, 0.16895259946329846, 0.16956752911279616, 0.17060195146564444, 0.16869136033926585, 0.16866464850012594, 0.16898295159618842, 0.17092209788136498, 0.1682807048675242, 0.16819169486141922, 0.16966149895195823, 0.16822387009481812, 0.17219202598102187, 0.1674502511098416, 0.16804592916521127, 0.1694299295773325, 0.17121549198069597, 0.1697209612736447, 0.16960418895301527, 0.1686389444911937, 0.1688401861655142, 0.1676558023865012, 0.16940374216513795, 0.170922015695443, 0.1691533841517967, 0.1686275087005105, 0.16726149403780488, 0.1694035836510379, 0.16903437954885625, 0.16882551464880372, 0.16912940065244825, 0.16867441581537468, 0.17122038326640834, 0.1668817379920779, 0.17038544274399442, 0.169048465387999, 0.16916057668116322, 0.16972194268585583, 0.1677109568959466, 0.17073668552433707, 0.16976641377831928, 0.17140950754893058, 0.17100958164998764, 0.16881244105752122, 0.16970673359218538, 0.17054662598041243, 0.16789710455703089, 0.16868354872588576, 0.16881695157875112, 0.170400795651482, 0.17155201783137145, 0.16869164286592755, 0.16850236883171554, 0.17018290071006834, 0.17146870553373306, 0.1696422699741637, 0.16928390493178466, 0.16760308678520372, 0.1716822759115499, 0.17100114590225834, 0.16961857440237585, 0.1713662796759428, 0.16911455741375234, 0.16808806586075925, 0.17039605896524748, 0.17085862277863234, 0.1699565066407707, 0.16699451708140145, 0.16928967313739504, 0.1681089848641645, 0.17032025111808222, 0.16760210143722526, 0.17195623632310517, 0.16732397593493564, 0.16803656417686316, 0.16818254224313614, 0.1690195872531122, 0.16968154991862533, 0.16883052779695684, 0.16963509427906395, 0.17224642840890195, 0.16717701385338074, 0.16997964102433338, 0.17152235492573695, 0.1686291389094692, 0.17049602484771173, 0.16820162892232549, 0.1695702659384425, 0.16831081941094478, 0.16816310860599734, 0.16760517015328147, 0.16905282865766671, 0.16822802587448293, 0.16958313769102318, 0.17004032416450796, 0.17048296267421656, 0.168534878377749, 0.17352192409854345, 0.1685930734747283, 0.1677292527730321, 0.16940290066603295, 0.168598265109067, 0.16996721567668766, 0.1698171088931149, 0.16939452187146656, 0.16805615394649817, 0.16810692271684496, 0.172005906876926, 0.1724371766152858, 0.17004717760189514, 0.1676341575882051, 0.1685308810292733, 0.1683498417999725, 0.16943066996956313, 0.16981118872448445, 0.17014069806523835, 0.16743542900954936, 0.16814433427582426, 0.1679972056561675, 0.16906844922571115, 0.1714120792838002, 0.16811061403757072, 0.16995410362751082, 0.16876412522230133, 0.16790578282158986, 0.16823906221733523, 0.16815719612026514, 0.16951026930392885, 0.1692115183264588, 0.16860956102003105, 0.16991307487411314, 0.16837907458516668, 0.1711454584968113, 0.16823649376607414, 0.16934889700544606, 0.16886984329242063, 0.16882073227528288, 0.16800150198329086, 0.17111483620768847, 0.16823225801626923, 0.1676420273711467, 0.1689922921536212, 0.16906171224096267, 0.17332525469409757, 0.17121708043201478, 0.16732518748631375, 0.16886551277203185, 0.1708351094935801, 0.1691656494862674, 0.16944555341340486, 0.16814047947134794, 0.17262866237879004, 0.17057131053101177, 0.16833724269596198, 0.1694907331482033, 0.16966245765769103, 0.1677480857552084, 0.16954880953168952, 0.1683771993125089, 0.16820621756795248, 0.17058677797361307, 0.16868280471395114, 0.16835765352130377, 0.16786712159944964, 0.16988340118615666, 0.16985928553784194, 0.16833180764167605, 0.1686679420941191, 0.1669176792562255, 0.1706090795537071, 0.16884898967517045, 0.168901146509911, 0.1707773913444925, 0.16802617552064167, 0.1686721168386958, 0.17004546271801582, 0.17065636098157827, 0.16741421745003657, 0.1685998297215327, 0.16936320420409554, 0.16905151602890606, 0.1732797570251992, 0.17074760168967767, 0.17400983196035555, 0.16784749242484318, 0.16897653988343944, 0.16901548755632326, 0.16942492864491526, 0.1683805113299886, 0.16931008353260135, 0.16714448309493585, 0.1682552129721338, 0.16960630319124198, 0.16886280883143812, 0.1690851437312769, 0.16753829199570494, 0.16893278618570517, 0.16797220445352787, 0.1685967346998828, 0.1687054664554284, 0.16866467034522045, 0.16803332902787402, 0.16861300954347658, 0.1678973264952451, 0.16838289278917706, 0.16772732826127087, 0.16786287854179346, 0.17307621961496172, 0.1683841380563869, 0.16740980311499812, 0.17099875643297932, 0.16957922632234215, 0.16790468866491948, 0.17011111986179045, 0.17067181736919734, 0.167903507629232, 0.17030420027546095, 0.17038772544063024, 0.16829997376389302, 0.16843250370385324, 0.1686558275007054, 0.16899444352261023, 0.17170073704412117, 0.17154986433062436, 0.16983543500488407, 0.16914918538418214, 0.17043941043457264, 0.17009589994962881, 0.17006385622527923, 0.168336132997657, 0.1695345730188202, 0.16772648568042803, 0.16808397525579874, 0.16893661077886873, 0.16906222640530988, 0.17101245756241262, 0.16959565550221317, 0.16741485386021823, 0.1676153960240965, 0.17285241635284038, 0.17066062427006895, 0.1692309277747378, 0.16737553005418115, 0.16707913713219, 0.16870727163881988, 0.16940350622776718, 0.16929362119835617, 0.1697274732185294, 0.16735295215851473, 0.16897684737131288, 0.16856885927364243, 0.16890201639795666, 0.1691272400452846, 0.16908315187910994, 0.168571466754828, 0.17201041769919506, 0.16840609175649465, 0.16859164899850498, 0.16757692584219905, 0.170106985003514, 0.17191373643129837, 0.16887845961079534, 0.16900187414225062, 0.16913220254317832, 0.16869411777301946, 0.16795693494947378, 0.16768375038599842, 0.16885296265282737, 0.16907237762452917, 0.1676969538425784, 0.1686623659876749, 0.16829367117422994, 0.1669877970294113, 0.1683033971324824, 0.1688469592771901, 0.1706088434460628, 0.16778016816726601, 0.16848654454528292, 0.1673228553969944, 0.16895921463846889, 0.16748093479815881, 0.17002686923226132, 0.16833909528606872, 0.16870378020087592, 0.1684824567720939, 0.1722143906035057, 0.17389708800636638, 0.1701715815662247, 0.16991455046467474, 0.16945608587398384, 0.1674307147693748, 0.1671531147624136, 0.16897815077636663, 0.16725898115804258, 0.1692683781672149, 0.1682984536156376, 0.1689166925838349, 0.16880031595333292, 0.16784524108135448, 0.16841454943556813, 0.16826109789747865, 0.16825552532615812, 0.1670615052112058, 0.16928206297598433, 0.1673751493091744, 0.16882978543378208, 0.1680221301639288, 0.16911045226765345, 0.17130817902791962, 0.1683692120280213, 0.16825843083947076, 0.16867372066749656, 0.16898918907180022, 0.16741437165944328, 0.16925959235821728, 0.16678622010428243, 0.1704356261934576, 0.16780353908360043, 0.16873265616505323, 0.16813291763423774, 0.1706732381967813, 0.1689817405517358, 0.16846772829943826, 0.16846213267274557, 0.1674294237998545, 0.1716250279611779, 0.16807910929577252, 0.16817759169054386, 0.16782775875514133, 0.1699037758144584, 0.16924757471555663, 0.16764771913840196, 0.17050176898799407, 0.17047069971467235, 0.16738383052736736, 0.17036664209320349, 0.16992168832232132, 0.16729279825801727, 0.16979574083051055, 0.1680772050766117, 0.16989570647036284, 0.167265376315306, 0.16752385295024128, 0.16907449278646206, 0.1675188153555922, 0.16787897290488665, 0.16835856518869088, 0.16862667169863035, 0.16759597518473976, 0.16802662763307918, 0.1680472608562625, 0.16686419349376194, 0.1683087456555322, 0.16875472743348094, 0.1672689507031771, 0.1673461747905566, 0.16901401571678773, 0.16793549734681879, 0.1694636476276266, 0.1712099655006441, 0.16696558713383225, 0.1668479469895848, 0.1683985515953183, 0.16761709071331052, 0.16849694136740082, 0.16862442003907838, 0.16923005918155012, 0.16831251343408876, 0.1685086872340041, 0.16918158946467227, 0.16979880771417855, 0.16817505166661842, 0.16749939940687014, 0.1683951258072865, 0.16660467040045107, 0.1674162848858522, 0.16936406636250118, 0.1689660926942949, 0.17100569067963245, 0.16798643362682827, 0.16736414157728613]
umap_train_loss_history = []
umap_test_loss_history = []


def objective(trial, X, y):
    print("Executing nn_objective...")
    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

    X_train = torch.tensor(X_train, dtype=torch.float32)
    X_test = torch.tensor(X_test, dtype=torch.float32)
    y_train = torch.tensor(y_train, dtype=torch.float32)
    y_test = torch.tensor(y_test, dtype=torch.float32)

    train_dataset = TensorDataset(X_train, y_train)
    train_dataloader = DataLoader(train_dataset, batch_size=64, shuffle=True)
    test_dataset = TensorDataset(X_test, y_test)
    test_dataloader = DataLoader(test_dataset, batch_size=64, shuffle=False)

    torch.manual_seed(42)
    model = NNModel(2, 64, 32, 19)
    MSE = nn.MSELoss()
    optimizer = optim.Adam(model.parameters(), lr=0.0001)

    best_mse = float('inf')
    best_weights = None

    train_loss_ma = None
    test_loss_ma = None
    convergence_threshold = 0.0001
    consecutive_epochs_no_improvement = 0

    # Training
    num_epoch = 3000
    for epoch in range(num_epoch):
        model.train()
        train_mse = 0.0
        for X_train_batch, y_train_batch in train_dataloader:
            optimizer.zero_grad()
            predictions = model.forward(X_train_batch)
            loss_value = MSE(predictions, y_train_batch)
            loss_value.backward()
            optimizer.step()
            train_mse += loss_value.item() * len(X_train_batch)

        train_mse /= len(X_train)
        umap_train_loss_history.append(train_mse)

        # Evaluating on the validation set
        model.eval()
        test_mse = 0.0
        with torch.no_grad():
            for X_test_batch, y_test_batch in test_dataloader:
                y_pred = model.forward(X_test_batch)
                batch_mse = MSE(y_pred, y_test_batch).item()
                test_mse += batch_mse * len(X_test_batch)

        test_mse /= len(X_test)
        umap_test_loss_history.append(test_mse)

        if train_loss_ma is None:
            train_loss_ma = train_mse
        else:
            train_loss_ma = (train_loss_ma * epoch + train_mse) / (epoch + 1)

        if test_loss_ma is None:
            test_loss_ma = test_mse
        else:
            test_loss_ma = (test_loss_ma * epoch + test_mse) / (epoch + 1)

        if epoch > 0:
            if abs(test_loss_ma - umap_test_loss_history[-2]) < convergence_threshold:
                consecutive_epochs_no_improvement += 1
                if consecutive_epochs_no_improvement >= 5:
                    print(f"Model converges at {epoch}th epoch")
                    break
            else:
                consecutive_epochs_no_improvement = 0

        if test_mse < best_mse:
            best_mse = test_mse
            best_weights = copy.deepcopy(model.state_dict())
            torch.save(model.state_dict(), "/home/fanqiany/data/fanqiany/UMAP.pth")
            print(f"Epoch {epoch + 1}/{num_epoch}, Test MSE: {test_mse:.6f}")

    return best_mse


def umap_model(trial):
    torch.manual_seed(42)
    # n_neighbors = trial.suggest_int('n_neighbors', 30, 90, step=10)
    # min_dist = trial.suggest_float('min_dist', 0.001, 0.025, step=0.004)
    # n_neighbors = trial.suggest_int('n_neighbors', 80, 80)
    # min_dist = trial.suggest_float('min_dist', 0.005, 0.005)

    Umap_model = umap.UMAP(n_neighbors=80, min_dist=0.005, n_components=2, random_state=42)
    umap_results = Umap_model.fit_transform(cleaned_df)
    np.save("/home/fanqiany/data/fanqiany/UMAP_results.npy", umap_results)

    return umap_results


# Create study objects and optimize for UMAP
umap_study = optuna.create_study(direction='minimize')
with tqdm(total=1, desc="Optimizing UMAP") as pbar:
    def callback(study, trial):
        pbar.update(1)
    umap_study.optimize(lambda trial: objective(trial, umap_model(trial), cleaned_df), n_trials=1, callbacks=[callback])
pbar.close()


# Print best parameters and results for UMAP
print("Best UMAP Parameters:", umap_study.best_params)
print("Best UMAP MSE:", umap_study.best_value)

# Explained variance
cov_matrix = np.cov(cleaned_df.T)
explained_var = 1 - 19 * umap_study.best_value / np.trace(cov_matrix)
print("Explained Variance of UMAP:", explained_var)

print("Train History:", umap_train_loss_history)
print("Test History:", umap_test_loss_history)


# Plot UMAP
def plot_umap(data):
    Umap_model = umap.UMAP(n_neighbors=80, min_dist=0.005, n_components=2, random_state=42)
    umap_results = Umap_model.fit_transform(data)

    plt.figure(figsize=(10, 8))
    hist = plt.hist2d(umap_results[:, 0], umap_results[:, 1], bins=(50, 50), cmap='viridis')
    plt.colorbar(hist[3], label='Frequency')
    plt.title(f'UMAP of Chemical Abundances (n_neighbors: {80}, min_dist: {0.005})')
    plt.xlabel('UMAP Component 1')
    plt.ylabel('UMAP Component 2')
    plt.grid(True)
    plt.savefig("/home/fanqiany/data/fanqiany/UMAP.png", dpi=300, bbox_inches='tight')
    plt.close()


plot_umap(cleaned_df)
